<html>
	<head>
		<!-- Mobile Viewport --> 
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" /> 
 
		<!-- iOS Full Screen --> 
		<meta name="apple-mobile-web-app-capable" content="yes" /> 
 
		<!-- iOS Status Bar Style (default, black, black-translucent) --> 
		<meta name="apple-mobile-web-app-status-bar-style" content="black" /> 

		<style type="text/css">

			* { 
				-webkit-tap-highlight-color: rgba(0,0,0,0);
				-webkit-text-size-adjust: none;
				-webkit-touch-callout: none; 
			}
 
			body {
 				margin: 0;
 				padding: 0;
 				overflow: hidden;
			}
 
			canvas {
				background-color: #333;
				border: 1px solid #999999;
				-webkit-touch-callout: none;
				-webkit-user-select: none;
				cursor: crosshair;				
			}
		</style>	
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script>
		<script src="/socket.io/socket.io.js"></script> 
		<script>
			jQuery(function($) {

				var resizeCanvas = function () {
					var canvasWidth = $(document).width();
					var canvasHeight = $(document).height();
			
					$(canvas).attr("height", canvasHeight);
					$(canvas).attr("width", canvasWidth);
				};

				var canvas = $("canvas");
				resizeCanvas();

				var pens = [];

				var deviceAgent = navigator.userAgent.toLowerCase();
				var isIPhone = deviceAgent.match(/(iphone|ipod|ipad)/);

				var getCanvasLocalCoordinates = function(pageX, pageY) {
					var position = canvas.offset();
					return({
						x: (pageX - position.left),
						y: (pageY - position.top)
					});
				};

				var sendCommand = function(command) {
					var penInfo = pens['local'];
					socket.send({
							command: command, 
							penInfo: penInfo
						});
				};

				var moveTo = function(x, y, who) {
					var localPosition = getCanvasLocalCoordinates(x, y);
					var penPoint = {
						x: localPosition.x,
						y: localPosition.y
					};
					var penInfo = {
						point: penPoint
					};
					pens[who] = penInfo;
				};

				var lineTo = function(x, y, who) {
					var localPosition = getCanvasLocalCoordinates(x, y);
					var penPoint = {
						x: localPosition.x,
						y: localPosition.y	
					};

					var penInfo = pens[who];
					var lastPenPoint = penInfo.point;
					console.log('Last point: ' + pens[who].point.x + ':' + pens[who].point.y);

					var pen = canvas[0].getContext("2d");
					pen.lineWidth = 5;
					pen.lineCap = "butt";
					pen.lineJoin = "round";
					if (who == 'local') {
						pen.strokeStyle = "#0066CC";
						pen.shadowColor = "#0066CC";
					}
					else {
						pen.strokeStyle = "#330044";
						pen.shadowColor = "#330044";						
					}
					pen.shadowBlur = 2;
					pen.beginPath();
					pen.moveTo(lastPenPoint.x, lastPenPoint.y);

					pen.lineTo(penPoint.x, penPoint.y);
					pen.stroke();
					penInfo.point = penPoint;
					pens[who] = penInfo;
					console.log('Last point: ' + pens[who].point.x + ':' + pens[who].point.y);
				};

				var getTouchEvent = function(event) {
					return(
						isIPhone 
							? window.event.targetTouches[0]
							: event);
				};

				var onTouchStart = function(event) {
					var touch = getTouchEvent(event);
					event.preventDefault();

					moveTo(touch.pageX, touch.pageY, 'local');
					sendCommand('moveTo');

					canvas.bind( (isIPhone ? "touchmove" : "mousemove"), onTouchMove);
					canvas.bind( (isIPhone ? "touchend": "mouseup"), onTouchEnd);
				};

				var onTouchMove = function(event) {
					var touch = getTouchEvent(event);
					lineTo(touch.pageX, touch.pageY, 'local');
					sendCommand('lineTo');
				};

				var onTouchEnd = function(event) {
					canvas.unbind((isIPhone ? "touchmove" : "mousemove"));
					canvas.unbind((isIPhone ? "touchend" : "mouseup"));
				};

				canvas.bind((isIPhone ? "touchstart" : "mousedown"), function(event) {
					onTouchStart(event);
				});

	 			var socket = new io.Socket(null, {transports: ['websocket', 'flashsocket', 'htmlfile', 'xhr-multipart', 'xhr-polling']}); 
	 			socket.connect();
	 			socket.on('connect', function() {
	 				console.log('Connected to host ' + socket.host);
	 			});
	 			socket.on('message', function(message) {
	 				var cmd = message.command;
	 				var penInfo = message.penInfo;
	 				var point = penInfo.point;
	 				if (cmd != undefined) {
	 					if (cmd == 'moveTo') {
	 						moveTo(point.x, point.y, 'remote');
	 					}
	 					else if (cmd == 'lineTo') {
	 						lineTo(point.x, point.y, 'remote');
	 					}
	 				}
	 			});
	 			socket.on('disconnect', function() {
	 				console.log("Disconnected from host " + socket.host);
	 			});

			});
		</script>
	</head>
	<body>
		<canvas id="canvas">
		</canvas>
	</body>
</html>